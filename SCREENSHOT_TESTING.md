# Screenshot Testing (Golden File Testing)

This document explains how to create and run screenshot tests for the project. These tests help catch unintended UI changes and ensure interface consistency.

## Creating a New Screenshot Test

All new UI-related tests, especially those requiring visual validation, should be treated as screenshot tests.

1.  **Test File Location**:
    New test files should be placed in a `test/` subdirectory related to the widget they are testing, typically within a `test/page/**/localizations/` folder.

2.  **Test File Content**:
    Each test file should follow the existing testing style and include these key parts:

    *   **Tag**: The test must include the `@Tags(['loc'])` tag. This allows the `run_generate_loc_snapshots.sh` script to identify and execute it.
    *   **`testLocalizations` Helper**: Use this function to generate screenshots for different locales and screen sizes.
    *   **Widget Preparation**: Inside the `testLocalizations` callback, prepare and render the widget you want to test. This usually involves wrapping your widget with `testableSingleRoute` or `testableRouteShellWidget` and providing necessary mocked dependencies.
    *   **Render and Settle**: Use `await tester.pumpWidget(widget)` and `await tester.pumpAndSettle()` to ensure the widget is fully rendered.

    For a complete guide on how to write a test, please refer directly to the existing test files in the project, as they are the best examples. For instance, you can check:
    `test/page/components/localizations/snack_bar_test.dart`

    This file, and others in the `test/page/**/localizations/` directory, demonstrate how to set up mocks, prepare widgets, and trigger interactions for screenshot testing.

### Mocking Notifiers

When testing widgets, we need a predictable and stable environment. Using real `Notifier` instances can introduce uncontrollable side effects like network requests or database access. Therefore, we must use mocked versions of notifiers to provide fixed states and behaviors.

This project uses [Mockito](https://pub.dev/packages/mockito) with [build_runner](https://pub.dev/packages/build_runner) to auto-generate mock classes, which require some manual adjustments.

**Step 1: Generate and Adjust the Mock Class**

1.  **Find or Create a `spec` file**: In the `test/mocks/mockito_specs/` directory, find the `_spec.dart` file corresponding to the Notifier you want to mock. If it doesn't exist, create one.

2.  **Add Mock Annotation**: In the `spec` file, add the `@GenerateNiceMocks` annotation and specify the `Notifier` class to be mocked.

    ```dart
    // test/mocks/mockito_specs/your_notifier_spec.dart
    @GenerateNiceMocks([MockSpec<YourNotifier>()])
    import 'package:mockito/annotations.dart';
    import 'package:your_project/providers/your_notifier_provider.dart';
    ```

3.  **Run Code Generation**: Execute the following command in the project root. `build_runner` will generate a `..._spec.mocks.dart` file in the same directory as the `spec` file.

    ```bash
    dart run build_runner build --delete-conflicting-outputs
    ```

4.  **Manual Adjustments (Important!)**
    
    *   **Move and Rename**: Move the newly generated `test/mocks/mockito_specs/your_notifier_spec.mocks.dart` file to the `test/mocks/` directory and rename it to `your_notifier_mocks.dart`. **This step is mandatory; otherwise, the file will be ignored by version control.**

    *   **Modify the Inheritance Declaration**: Open the new `your_notifier_mocks.dart` file and find the class declaration generated by `build_runner`. You must modify it manually.

        **Before (as generated by `build_runner`):**
        ```dart
        class MockYourNotifier extends Mock implements YourNotifier { ... }
        ```

        **After (Example):**
        ```dart
        // For a standard Notifier
        class MockYourNotifier extends Notifier<YourState> with Mock implements YourNotifier { ... }

        // For an AsyncNotifier
        class MockYourAsyncNotifier extends AsyncNotifier<YourState> with Mock implements YourAsyncNotifier { ... }
        ```
        You need to replace `extends Mock` with `extends [Original Notifier Class] with Mock`. For example, `extends Notifier<_i3.DashboardManagerState> with _i1.Mock`.

    > **Important Note**: If the original `Notifier` interface changes (e.g., a method is added or modified), you need to re-run the `build_runner` command and repeat the **manual adjustment steps** above to ensure the mock class stays in sync with the latest interface.


**Step 2: Using the Mock in a Test**

1.  **Declare and Initialize**: In your test file, declare a variable for the mock object and initialize it in the `setUp` function.

2.  **Stubbing Behavior**: Use `when(...).thenReturn(...)` to define the state that should be returned when a method on the notifier (especially `build()`) is called. This gives you precise control over the initial state of your widget.

3.  **Override Provider**: In the `overrides` parameter of `testableSingleRoute` or `testableRouteShellWidget`, use `yourProvider.overrideWith(() => yourMockNotifier)` to replace the real provider with your mock implementation.

    ```dart
    // ... imports, including the generated and adjusted mock file
    import '../../mocks/your_notifier_mocks.dart';

    void main() {
      late MockYourNotifier mockYourNotifier;

      setUp(() {
        // Create a new mock instance for each test
        mockYourNotifier = MockYourNotifier();
      });

      testLocalizations('Your widget with mocked state', (tester, locale) async {
        // Stub the build() method to define the initial state
        when(mockYourNotifier.build()).thenReturn(YourState(someValue: 'mock data'));

        // (Optional) Stub other methods
        when(mockYourNotifier.someAsyncMethod()).thenAnswer((_) async => true);

        final widget = testableSingleRoute(
          locale: locale,
          overrides: [
            // Override the provider here
            yourNotifierProvider.overrideWith(() => mockYourNotifier),
          ],
          child: YourWidgetToTest(),
        );

        await tester.pumpWidget(widget);
        await tester.pumpAndSettle();
      });
    }
    ```

## Running Screenshot Tests

Use the existing `run_generate_loc_snapshots.sh` script to run all tests tagged with `loc` (which now includes our screenshot tests).

*   **Run all tests (with default settings)**:
    Simply run the script. It will use the default locale (`en`) and screen sizes (`480,1280`).

    ```bash
    ./run_generate_loc_snapshots.sh
    ```

*   **Run with specific locales and screen sizes**:
    You can use the `-l` (locales) and `-s` (screens) parameters.

    ```bash
    # Test for Spanish and Japanese with screen widths of 400 and 800
    ./run_generate_loc_snapshots.sh -l "es,ja" -s "400,800"
    ```

*   **Run a single test file**:
    Use the `-f` parameter to specify a particular test file.

    ```bash
    ./run_generate_loc_snapshots.sh -f test/page/your/specific_test.dart
    ```

## Updating Golden Files

When you have intentionally changed the UI and need to update the corresponding screenshots, simply run the `run_generate_loc_snapshots.sh` script.

The script includes the `--update-goldens` flag, which will automatically overwrite the old files with the new screenshots. Since the golden files are ignored by `.gitignore`, you do not need to commit them to version control.