# Mock Generation and Maintenance Guide

This document describes the workflow for generating, updating, and maintaining Mock files in this project.

---

## Directory Structure

```
test/mocks/
├── mockito_specs/                    # Mockito spec files (define which Mocks to generate)
│   ├── wifi_bundle_settings_notifier_spec.dart
│   ├── wifi_bundle_settings_notifier_spec.mocks.dart  # Auto-generated (.gitignore)
│   └── ...
├── wifi_bundle_settings_notifier_mocks.dart          # Manually maintained Mock files
├── dashboard_manager_notifier_mocks.dart
└── ...
```

---

## Mock Generation Workflow

### 1. Define Spec File

Create a spec file in the `test/mocks/mockito_specs/` directory:

```dart
// wifi_bundle_settings_notifier_spec.dart
@GenerateNiceMocks([MockSpec<WifiBundleNotifier>()])
import 'package:mockito/annotations.dart';
import 'package:privacy_gui/page/wifi_settings/providers/wifi_bundle_provider.dart';
```

### 2. Run build_runner

```bash
cd /Users/austin.chang/flutter-workspaces/privacyGUI/PrivacyGUI
dart run build_runner build --delete-conflicting-outputs
```

This generates `*_spec.mocks.dart` files in the `mockito_specs/` directory.

### 3. Copy to mocks Directory and Fix Inheritance

Copy the generated file to the `test/mocks/` directory:

```bash
cp test/mocks/mockito_specs/wifi_bundle_settings_notifier_spec.mocks.dart \
   test/mocks/wifi_bundle_settings_notifier_mocks.dart
```

### 4. Fix Class Inheritance (Important!)

The Mock class generated by Mockito may have an incorrect inheritance structure:

```dart
// ❌ Incorrect generated result (sometimes happens)
class MockWifiBundleNotifier extends _i1.Mock
    implements _i4.WifiBundleNotifier {

// ✅ Correct inheritance structure
class MockWifiBundleNotifier extends _i2.Notifier<_i3.WifiBundleState> with _i1.Mock
    implements _i4.WifiBundleNotifier {
```

**Rule**: All classes extending `Notifier<T>` must use the `extends Notifier<T> with Mock` pattern in their Mock.

---

## Adding New Methods to a Notifier

When you add new public methods to a Notifier:

### Step 1: Modify the Notifier

```dart
// wifi_bundle_provider.dart
class WifiBundleNotifier extends Notifier<WifiBundleState> {
  // New method
  bool checkingMLOSettingsConflicts(Map<WifiRadioBand, WiFiItem> radios,
      {bool? isMloEnabled}) {
    return ref.read(wifiSettingsServiceProvider)
        .checkingMLOSettingsConflicts(radios, isMloEnabled: isMloEnabled);
  }
}
```

### Step 2: Regenerate the Mock

```bash
dart run build_runner build --delete-conflicting-outputs
```

### Step 3: Copy and Fix

```bash
cp test/mocks/mockito_specs/wifi_bundle_settings_notifier_spec.mocks.dart \
   test/mocks/wifi_bundle_settings_notifier_mocks.dart
```

Check and fix the inheritance structure (as described above).

### Step 4: Update TestHelper Default Stubs

Add a default stub in `_setupDefaultData()` in `test/common/test_helper.dart`:

```dart
when(mockWiFiBundleNotifier.checkingMLOSettingsConflicts(any,
        isMloEnabled: anyNamed('isMloEnabled')))
    .thenReturn(false);
```

---

## Mock Configuration in TestHelper

### Declare Mock

```dart
class TestHelper {
  late MockWifiBundleNotifier mockWiFiBundleNotifier;
  // ...
}
```

### Initialize

```dart
void setup() {
  mockWiFiBundleNotifier = MockWifiBundleNotifier();
  // ...
  _setupDefaultData();
}
```

### Set Default Stubs

```dart
void _setupDefaultData() {
  // State
  when(mockWiFiBundleNotifier.build())
      .thenReturn(wifiBundleTestStateInitialState);
  when(mockWiFiBundleNotifier.state)
      .thenReturn(wifiBundleTestStateInitialState);
  
  // Methods
  when(mockWiFiBundleNotifier.isDirty()).thenReturn(false);
  when(mockWiFiBundleNotifier.validateWifiListSettings(any)).thenReturn(true);
  when(mockWiFiBundleNotifier.checkingMLOSettingsConflicts(any,
          isMloEnabled: anyNamed('isMloEnabled')))
      .thenReturn(false);
}
```

### Override Provider

```dart
List<Override> get defaultOverrides => [
  wifiBundleProvider.overrideWith(() => mockWiFiBundleNotifier),
  // ...
];
```

---

## Overriding Default Behavior in Tests

```dart
testLocalizationsV2(
  'Verify save confirmation modal with MLO warning',
  (tester, screen) async {
    // Override default behavior
    when(testHelper.mockWiFiBundleNotifier.checkingMLOSettingsConflicts(any,
            isMloEnabled: anyNamed('isMloEnabled')))
        .thenReturn(true);  // Change to true to trigger warning

    final context = await testHelper.pumpShellView(
      tester,
      child: const WiFiMainView(),
      locale: screen.locale,
    );
    // ...
  },
);
```

---

## Frequently Asked Questions

### Q: Why doesn't `when(...).thenReturn(...)` work?

**A**: Check the following:
1. Is the Mock object correctly overridden in `defaultOverrides`?
2. Does the method signature match exactly (including nullable parameters)?
3. When using `any`, ensure the parameter types match.

### Q: The generated Mock is missing some methods

**A**: 
1. Ensure the method is public (not starting with `_`)
2. Re-run `dart run build_runner build --delete-conflicting-outputs`
3. Confirm the file was copied to the `test/mocks/` directory

### Q: `undefined_method` error in tests

**A**: 
1. Confirm the Mock file has been updated
2. Confirm you correctly copied the generated Mock file
3. Check if the inheritance structure is correct

---

## File Naming Conventions

| Type | Naming Pattern | Example |
|------|----------------|---------|
| Spec file | `{name}_spec.dart` | `wifi_bundle_settings_notifier_spec.dart` |
| Generated Mock (.gitignore) | `{name}_spec.mocks.dart` | `wifi_bundle_settings_notifier_spec.mocks.dart` |
| Maintained Mock file | `{name}_mocks.dart` | `wifi_bundle_settings_notifier_mocks.dart` |
